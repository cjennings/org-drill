* Org Drill Open Work
** SEVERITY A - CRITICAL BUGS




** SEVERITY B - HIGH PRIORITY BUGS

*** TODO [#A] Fix potential division by zero (Line 887)
:PROPERTIES:
:LOCATION: org-drill.el:887
:SEVERITY: B
:END:

Division by =last-interval= without checking if it's zero in =org-drill-entry-overdue-p=.

*Impact:* If =last-interval= is 0 (new items or after failures), causes division-by-zero error and crashes drill session.

*Fix:* Add check: =(and (> last-interval 0) (> (/ ...) ...))=

*** TODO [#A] Fix infinite loop in marker selection (Lines 2498-2500)
:PROPERTIES:
:LOCATION: org-drill.el:2498-2500
:SEVERITY: B
:END:

Variable =m= may remain nil or invalid, creating infinite loop when all entries are invalid.

*Impact:* Infinite loop if all pending entries become invalid (deleted or no longer have drill tag).

*Fix:* Add safety counter or ensure loop can exit when no valid entries remain.

*** TODO [#B] Fix race condition with timer cleanup (Lines 1662-1665, 1768)
:PROPERTIES:
:LOCATION: org-drill.el:1662-1665,1768
:SEVERITY: B
:END:

=org-drill-presentation-timer-cancel= may not properly cancel timer in all execution paths.

*Impact:* Timer continues running after session ends, consuming resources and potentially causing errors.

*Fix:* Wrap timer cancellation in =unwind-protect= blocks and add error handling.

*** TODO [#B] Fix docstring typo: "dasy" should be "days" (Line 876)
:PROPERTIES:
:LOCATION: org-drill.el:876
:SEVERITY: B
:END:

Typo in docstring: "dasy" instead of "days"

*Impact:* Documentation error confusing users and maintainers.

*Fix:* Change "dasy" to "days"

*** TODO [#B] Fix marker leak in error cases (Lines 2687-2700)
:PROPERTIES:
:LOCATION: org-drill.el:2687-2700
:SEVERITY: B
:END:

=org-drill-free-markers= only frees markers in normal exit paths.

*Impact:* Memory leaks in long-running Emacs sessions when drill sessions are interrupted.

*Fix:* Use =unwind-protect= to ensure markers are always freed.

** SEVERITY C - MEDIUM PRIORITY ISSUES

*** TODO [#C] Fix inconsistent error handling for empty property blocks (Line 2138)
:PROPERTIES:
:LOCATION: org-drill.el:2138
:SEVERITY: C
:END:

Uses =(or (cdr (org-get-property-block)) (point))= which may return invalid position.

*Impact:* Could hide wrong text or fail to hide expected text in cloze processing.

*Fix:* Add proper validation and error messaging.

*** TODO [#C] Remove or implement unused variable in commented code (Line 1472)
:PROPERTIES:
:LOCATION: org-drill.el:1472
:SEVERITY: C
:END:

Commented-out code referencing =failures= variable suggests incomplete refactoring.

*Impact:* Code maintainability issue; suggests incomplete bug fix.

*Fix:* Either implement intended logic or remove comment.

*** TODO [#C] Fix buffer corruption in org-drill-merge-buffers (Lines 3221-3223)
:PROPERTIES:
:LOCATION: org-drill.el:3164-3252
:SEVERITY: C
:END:

Function uses =switch-to-buffer= repeatedly, affecting window configuration.

*Impact:* Could fail in batch mode or corrupt user's window state during merge.

*Fix:* Use =with-current-buffer= instead of =switch-to-buffer=.

*** TODO [#C] Extract hardcoded magic number for lapsed days (Lines 2709-2710, 2726)
:PROPERTIES:
:LOCATION: org-drill.el:2709-2710,2726
:SEVERITY: C
:END:

Value 90 is hardcoded in multiple places.

*Impact:* Inconsistent behavior; maintenance burden.

*Fix:* Define as customizable variable.

*** TODO [#C] Fix incorrect property name in org-drill-show-answer-verb-conjugation (Line 3228)
:PROPERTIES:
:LOCATION: org-drill.el:3228
:SEVERITY: C
:END:

Uses =LAST_QUALITY= instead of =DRILL_LAST_QUALITY=.

*Impact:* Creates wrong property name, breaking consistency. Data stored but never read correctly.

*Fix:* Change to =DRILL_LAST_QUALITY=

*** TODO [#C] Fix property name typo (Line 3231)
:PROPERTIES:
:LOCATION: org-drill.el:3231
:SEVERITY: C
:END:

Uses =LAST_REVIEWED= instead of =DRILL_LAST_REVIEWED=.

*Impact:* Data stored under wrong property name.

*Fix:* Change to =DRILL_LAST_REVIEWED=

*** TODO [#C] Add error handling in org-drill-entry-days-since-creation (Line 2738)
:PROPERTIES:
:LOCATION: org-drill.el:2738
:SEVERITY: C
:END:

=org-time-stamp-to-now= can fail if timestamp is malformed.

*Impact:* Malformed timestamps in DATE_ADDED property cause unhandled errors.

*Fix:* Wrap in condition-case and return nil or sensible default on error.

** SEVERITY D - LOW PRIORITY ISSUES

*** TODO [#C] Remove commented debug message (Line 2560)
:PROPERTIES:
:LOCATION: org-drill.el:2560
:SEVERITY: D
:END:

Debug message left in production code.

*Impact:* Clutters user's message buffer with debug info.

*Fix:* Remove or wrap in debug flag check.

*** TODO [#C] Improve variable naming (Line 2806)
:PROPERTIES:
:LOCATION: org-drill.el:2806
:SEVERITY: D
:END:

Variables =sym1= and =sym2= lack clear semantic meaning.

*Impact:* Code readability and maintainability.

*Fix:* Use descriptive names like =current-meter-char= and =alternate-meter-char=.

*** TODO [#C] Standardize use of setq vs setf (Throughout)
:PROPERTIES:
:LOCATION: org-drill.el:Throughout
:SEVERITY: D
:END:

Mixed use of =setq= and =setf= without clear pattern.

*Impact:* Code style inconsistency.

*Fix:* Standardize on =setq= for simple variables, =setf= for generalized places.

*** TODO [#C] Make entry text limit configurable (Line 1996)
:PROPERTIES:
:LOCATION: org-drill.el:1996
:SEVERITY: D
:END:

Hardcoded 100 char max may be inefficient.

*Impact:* Minor performance impact for large entries.

*Fix:* Make character limit configurable.

*** TODO [#C] Add input validation in org-drill-shuffle (Lines 3656-3662)
:PROPERTIES:
:LOCATION: org-drill.el:3656-3662
:SEVERITY: D
:END:

No validation that LIST is actually a list.

*Impact:* Cryptic error if called with non-list argument.

*Fix:* Add type check at function start.

*** TODO [#C] Fix docstring style inconsistency (Line 876)
:PROPERTIES:
:LOCATION: org-drill.el:876
:SEVERITY: D
:END:

Uses "Returns" instead of "Return" (imperative mood).

*Impact:* Documentation style inconsistency with Emacs conventions.

*Fix:* Use imperative mood in docstrings.

*** TODO [#C] Document magic numbers in SM8 algorithm (Lines 1201, 1211, 1220)
:PROPERTIES:
:LOCATION: org-drill.el:1201,1211,1220
:SEVERITY: D
:END:

Magic numbers in formulas without explanation.

*Impact:* Makes code hard to understand and maintain.

*Fix:* Add comments explaining constants' origin and meaning (SM8 algorithm).

** ENHANCEMENTS - TOP 10 PRIORITIES

*** TODO [#A] Anki Deck Import/Export
:PROPERTIES:
:CATEGORY: Integration
:COMPLEXITY: High
:VALUE: Very High
:END:

Bidirectional conversion between Anki deck format (.apkg) and org-drill format.

*Rationale:* Unlocks massive ecosystem of existing Anki decks; major barrier to adoption removed.

*Implementation:*
- Parse .apkg (SQLite database inside zip)
- Map Anki note types to org-drill card types
- Convert scheduling data between algorithms
- Consider using external tool (Python script) calling into Emacs

*** TODO [#A] Comprehensive Statistics Dashboard
:PROPERTIES:
:CATEGORY: Analytics
:COMPLEXITY: High
:VALUE: Very High
:END:

Detailed statistics view showing learning trends, forecasts, heatmaps, etc.

*Rationale:* Current end-of-session summary is minimal; users want to track progress over time.

*Implementation:*
- Store session history in org-persist
- Interactive buffer with org-mode tables and sparklines
- Show: reviews/day, retention rate, time spent, difficult cards
- Export to CSV for external analysis

*** TODO [#B] Enhanced Session Progress Visualization
:PROPERTIES:
:CATEGORY: UX
:COMPLEXITY: Medium
:VALUE: High
:END:

Add persistent progress bar or visual indicator showing session progress.

*Rationale:* Users benefit from visual progress tracking during sessions, similar to Anki's progress bars.

*Implementation:*
- Use mode-line or header-line for persistent display
- Leverage existing session tracking in org-drill-session class
- Update display in org-drill--make-minibuffer-prompt
- Could use unicode block characters for simple progress bars

*** TODO [#B] Learning Profiles/Presets
:PROPERTIES:
:CATEGORY: Configuration
:COMPLEXITY: Low
:VALUE: High
:END:

Predefined configuration sets for different learning scenarios (language learning, medical school, casual learning).

*Rationale:* Current customization is overwhelming; presets make it accessible.

*Implementation:*
- Define alist of preset configurations
- Interactive command to apply preset
- Store in separate file, easily shareable
- Include algorithm choice, session limits, forgetting threshold

*** TODO [#B] Undo/Retry Last Rating
:PROPERTIES:
:CATEGORY: UX
:COMPLEXITY: Low
:VALUE: High
:END:

Allow users to undo their last quality rating if they pressed the wrong key.

*Rationale:* Accidents happen; currently no way to correct misrated card without manual property editing.

*Implementation:*
- Store previous item state before scheduling
- Add 'u' key for undo in org-drill-reschedule
- Restore previous scheduling data from backup
- Limit to last 1-3 items for simplicity

*** TODO [#B] Incremental/Lazy Loading
:PROPERTIES:
:CATEGORY: Performance
:COMPLEXITY: High
:VALUE: High
:END:

Load and process entries incrementally rather than scanning entire collection upfront.

*Rationale:* Current system scans all entries at session start; slow for large collections (>10,000 cards).

*Implementation:*
- Use persistent cache of entry states (org-persist)
- Only scan modified files since last session
- Stream processing instead of building full lists
- Track file modification times

*** TODO [#B] FSRS (Free Spaced Repetition Scheduler) Algorithm
:PROPERTIES:
:CATEGORY: Core Functionality
:COMPLEXITY: High
:VALUE: Very High
:END:

Implement FSRS algorithm as alternative to SM2/SM5/Simple8.

*Rationale:* FSRS is modern state-of-the-art algorithm used in Anki, with proven better retention.

*Implementation:*
- Study FSRS algorithm from Anki's open-source implementation
- Add as fourth option to org-drill-spaced-repetition-algorithm
- Maintain backward compatibility with existing scheduling data
- May require additional properties per card

*** TODO [#B] Graduated Intervals for New Cards
:PROPERTIES:
:CATEGORY: Core Functionality
:COMPLEXITY: High
:VALUE: High
:END:

Add customizable learning steps for new cards (e.g., 1m, 10m, 1d, 3d) before graduating to review.

*Rationale:* Current system only distinguishes new vs. mature; Anki's graduated intervals are proven effective for initial learning.

*Implementation:*
- Add :learning-steps slot to session class
- New property DRILL_LEARNING_STEP for cards in learning
- Modify org-drill-entry-new-p to handle learning states
- Update org-drill-smart-reschedule for learning transitions

*** TODO [#C] Mobile App Companion / Mobile-Friendly Export
:PROPERTIES:
:CATEGORY: Integration
:COMPLEXITY: High
:VALUE: Very High
:END:

Export cards to format usable by mobile apps (AnkiDroid, or custom PWA).

*Rationale:* Mobile study is essential; org-drill is currently Emacs-only.

*Implementation:*
- Export to Anki format (leveraging Anki Import/Export enhancement)
- Or create JSON/HTML5 export with LocalStorage
- Sync back scheduling data via file merge
- Progressive Web App could work offline

*** TODO [#C] Retention Rate Tracking
:PROPERTIES:
:CATEGORY: Analytics
:COMPLEXITY: Medium
:VALUE: High
:END:

Calculate and display retention rate over different time periods (7-day, 30-day, all-time).

*Rationale:* Key metric for evaluating learning effectiveness; not currently tracked.

*Implementation:*
- Store session outcomes with timestamps
- Calculate success rate: (cards rated â‰¥3) / (total cards reviewed)
- Display trends over time
- Alert when retention drops below threshold

** ENHANCEMENTS - ADDITIONAL FEATURES (by category)

*** TODO [#C] Card Preview Mode (UX)
:PROPERTIES:
:CATEGORY: UX
:COMPLEXITY: Low
:END:

Add non-destructive preview mode to review cards without affecting scheduling.

*** TODO [#C] Customizable Color Schemes (UX)
:PROPERTIES:
:CATEGORY: UX
:COMPLEXITY: Low
:END:

Allow themes/presets for drill session color scheme (currently hardcoded).

*** TODO [#C] Improved Help System (UX)
:PROPERTIES:
:CATEGORY: UX
:COMPLEXITY: Low
:END:

Add comprehensive in-session help (F1 or ? key) showing all available commands and shortcuts.

*** TODO [#C] Configurable Font Size and Display Properties
:PROPERTIES:
:CATEGORY: UX
:COMPLEXITY: Low
:VALUE: Medium
:END:

Allow users to increase font size and customize text properties during drill sessions.

*Rationale:* Larger text improves readability during study sessions, especially for users with vision issues or when studying from a distance. Similar to presentation modes in other applications.

*Implementation:*
- Add customizable variable for default drill session text scale (e.g., =org-drill-text-scale-amount=)
- Apply =text-scale-increase= or =buffer-face-mode= when entering drill session
- Add keybindings (C-+ / C-- / C-0) to adjust font size during session
- Optionally set in =org-drill-response-mode= and question display buffers
- Store preference per-user or per-deck
- Could also customize faces for question/answer/cloze text

*** TODO [#C] Session Pause/Resume with Timer (UX)
:PROPERTIES:
:CATEGORY: UX
:COMPLEXITY: Medium
:END:

Add ability to pause session timer for breaks and see elapsed time.

*** TODO [#C] Card Suspension and Burying (Core)
:PROPERTIES:
:CATEGORY: Core Functionality
:COMPLEXITY: Medium
:END:

Add ability to temporarily suspend cards or bury them until next session.

*** TODO [#C] Sibling Card Handling (Core)
:PROPERTIES:
:CATEGORY: Core Functionality
:COMPLEXITY: Medium
:END:

Prevent showing cards from the same parent heading in same session.

*** TODO [#C] Filtered Decks / Custom Study (Core)
:PROPERTIES:
:CATEGORY: Core Functionality
:COMPLEXITY: Medium
:END:

Create temporary drill sessions with custom filters (e.g., "all failed cards", "cards added this week").

*** TODO [#C] org-roam Integration
:PROPERTIES:
:CATEGORY: Integration
:COMPLEXITY: Medium
:END:

Create drill cards directly from org-roam nodes with bidirectional linking.

*** TODO [#C] Better org-agenda Integration
:PROPERTIES:
:CATEGORY: Integration
:COMPLEXITY: Low-Medium
:END:

Show drill statistics in agenda view, schedule drill sessions as tasks.

*** TODO [#C] Database/Index for Card Metadata (Performance)
:PROPERTIES:
:CATEGORY: Performance
:COMPLEXITY: High
:END:

Maintain SQLite database or cache of card metadata for instant lookups.

*** TODO [#C] Per-Deck/Per-File Configuration
:PROPERTIES:
:CATEGORY: Configuration
:COMPLEXITY: Low
:END:

Allow different settings for different collections beyond file-local variables.

*** TODO [#C] Card Difficulty Heatmap (Analytics)
:PROPERTIES:
:CATEGORY: Analytics
:COMPLEXITY: Medium
:END:

Visual representation of which cards/topics are difficult by failure rate or ease factor.

*** TODO [#C] Learning Forecast (Analytics)
:PROPERTIES:
:CATEGORY: Analytics
:COMPLEXITY: Medium
:END:

Predict review workload for next days/weeks based on current card intervals.

*** TODO [#C] Audio Recording Support (Modern Features)
:PROPERTIES:
:CATEGORY: Modern Features
:COMPLEXITY: Medium
:END:

Record and attach audio clips to cards (useful for language learning).

*** TODO [#C] Text-to-Speech for Cards (Modern Features)
:PROPERTIES:
:CATEGORY: Modern Features
:COMPLEXITY: Medium
:END:

Automatically generate speech from card text for listening practice.

* Org Drill Resolved Work

*** DONE [#A] Fix typo in EIEIO class slot definition (Line 612)
CLOSED: [2025-11-13 Wed]
:PROPERTIES:
:LOCATION: org-drill.el:612
:SEVERITY: A
:END:

Misspelled =:documementation= instead of =:documentation= in the =cram-mode= slot definition.

*Impact:* EIEIO fails to recognize slot documentation. May cause issues with introspection and help systems.

*Fix:* Changed =:documeentation= to =:documentation=

*Resolution:* Fixed in commit 2ea3f1f

*** DONE [#A] Replace unsafe use of read() with safer alternatives
CLOSED: [2025-11-13 Wed]
:PROPERTIES:
:LOCATION: org-drill.el:1068,1353,1406,2838
:SEVERITY: A
:TYPE: Security
:END:

Using =read= function on property values without sanitization. Major security vulnerability - arbitrary code execution possible.

*Impact:* If attacker controls org-mode properties (shared files, malicious imports), they could execute arbitrary code.

*Fix Applied:*
- Lines 1353, 1406: Changed =(read weight)= to =(string-to-number weight)= for DRILL_CARD_WEIGHT
- Line 2838: Changed =read= to =string-to-number= for DRILL_LAST_INTERVAL  
- Line 1068: Created =org-drill--safe-read-learn-data= helper function that:
  - Uses =read-from-string= instead of =read=
  - Validates input is a list with at least 3 numeric elements
  - Returns nil on invalid/malicious input with error handling
  - Falls back to safe defaults if LEARN_DATA is corrupted

*Resolution:* Fixed in commit 9d9c0be

*** DONE [#A] Fix missing return value in org-drill-get-tags-advice
CLOSED: [2025-11-13 Wed]
:PROPERTIES:
:LOCATION: org-drill.el:704-714
:SEVERITY: A
:END:

Function didn't return a value when =(= 2 (length args))= is true but =org-get-local-tags= doesn't exist.

*Impact:* In older org-mode versions, returns nil instead of falling back to original function, breaking tag functionality.

*Fix Applied:*
- Removed underscore from =orig-fun= parameter (now used)
- Added else clause to fallback to =(apply orig-fun args)= when =org-get-local-tags= doesn't exist
- Added explanatory comment

*Resolution:* Fixed in commit df3a67f
